<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <title>Rede de Catadores – Teste</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- TailwindCSS via CDN (visual rápido) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script> tailwind.config = { darkMode: 'class' };</script>

    <!-- React 18 + ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel Standalone para JSX neste arquivo -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js para gráficos dos Relatórios (opcional) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-emerald-50 to-neutral-50 text-neutral-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef } = React;

      const API_URL = "http://127.0.0.1:8000"

      // ========== Utils ==========
      const cls = (...xs) => xs.filter(Boolean).join(" ");
      const money = (n) =>
        new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(Number(n||0));
      const fmtDateBR = (iso) => {
        if (!iso) return "";
        const d = new Date(iso);
        if (isNaN(d)) return iso;
        return d.toLocaleDateString("pt-BR");
      };
      const todayISO = () => new Date().toISOString().slice(0, 10);
      const sameYM = (iso, ref=new Date()) => {
        const d = new Date(iso);
        return d.getFullYear() === ref.getFullYear() && d.getMonth() === ref.getMonth();
      };
      const inRange = (iso, startISO, endISO) => {
        const t = new Date(iso).getTime();
        if (isNaN(t)) return false;
        const a = startISO ? new Date(startISO).getTime() : -Infinity;
        const b = endISO ? new Date(endISO).getTime() + 24*60*60*1000 - 1 : Infinity; // incl. dia final
        return t >= a && t <= b;
      };

      // ========== Mock + persistência local ==========
      const STORAGE_KEY = "rc_mock_data_v3";
      const seed = {
        materiais: [
          { id: 1, nome: "PET", categoria: "Plástico", unidade: "kg" },
          { id: 2, nome: "Papelão", categoria: "Papel", unidade: "kg" },
        ],
        associacoes: [
          { id: 1, nome: "Associação Central", cnpj: "00.000.000/0001-00", contato: "contato@central.org" },
        ],
        recebimentos: [
          { id: 1, data: todayISO(), materialId: 1, associacaoId: 1, quantidade: 150 },
        ],
        vendas: [
          { id: 1, data: todayISO(), materialId: 1, quantidade: 60, precoUnit: 2.5 },
        ],
      };
      const load = () => {
        try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : seed; }
        catch { return seed; }
      };
      const save = (data) => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch {} };
      const nextId = (list) => (list?.reduce((m, x) => Math.max(m, x.id ?? 0), 0) || 0) + 1;

      // ========== UI building blocks ==========
      const Card = ({ children, className }) => (
        <div className={cls("rounded-2xl border border-black/5 bg-white shadow-sm", className)}>{children}</div>
      );
      const StatCard = ({ title, value, subtitle }) => (
        <div className="bg-white/80 rounded-2xl shadow-sm p-5 border border-black/5">
          <div className="text-sm text-neutral-500">{title}</div>
          <div className="text-3xl font-semibold mt-1">{value}</div>
          {subtitle && <div className="text-xs mt-2 text-neutral-400">{subtitle}</div>}
        </div>
      );
      const Toolbar = ({ children }) => (
        <div className="flex flex-col sm:flex-row sm:items-center gap-3 justify-between mb-4">{children}</div>
      );
      const Pill = ({ active, onClick, children }) => (
        <button
          onClick={onClick}
          className={cls(
            "px-4 py-2 rounded-full border text-sm transition",
            active ? "bg-emerald-600 text-white border-emerald-700"
                   : "bg-white text-neutral-700 border-neutral-200 hover:bg-neutral-50"
          )}
        >
          {children}
        </button>
      );
      const Table = ({ columns, data, emptyLabel="Sem dados" }) => (
        <div className="overflow-hidden rounded-2xl border border-neutral-200 bg-white shadow-sm">
          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-neutral-50">
                <tr>
                  {columns.map(c => (
                    <th key={c.key} className="text-left px-4 py-3 font-medium text-neutral-600">{c.header}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {data.length === 0 ? (
                  <tr><td colSpan={columns.length} className="px-4 py-10 text-center text-neutral-400">{emptyLabel}</td></tr>
                ) : data.map((row, i) => (
                  <tr key={row.id ?? i} className={i % 2 ? "bg-white" : "bg-neutral-50/40"}>
                    {columns.map(c => (
                      <td key={c.key} className="px-4 py-3 text-neutral-800">
                        {c.render ? c.render(row[c.key], row) : row[c.key]}
                      </td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
      const Drawer = ({ open, onClose, title, children }) => (
        <div className={cls("fixed inset-0 z-50 transition", open ? "pointer-events-auto" : "pointer-events-none")}>
          <div className={cls("absolute inset-0 bg-black/40 transition-opacity", open ? "opacity-100" : "opacity-0")} onClick={onClose}/>
          <div className={cls(
            "absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-xl border-l border-neutral-200 p-6 transition-transform",
            open ? "translate-x-0" : "translate-x-full"
          )} role="dialog" aria-modal="true">
            <div className="flex items-start justify-between mb-4">
              <h3 className="text-lg font-semibold">{title}</h3>
              <button onClick={onClose} className="rounded-full w-8 h-8 grid place-items-center border border-neutral-200 hover:bg-neutral-50" aria-label="Fechar">×</button>
            </div>
            {children}
          </div>
        </div>
      );
      const TextInput = ({ label, value, onChange, placeholder, type="text", required }) => {
        const id = useMemo(() => Math.random().toString(36).slice(2), []);
        return (
          <label className="block">
            <span className="text-sm text-neutral-600">{label}</span>
            <input
              id={id} type={type} value={value} required={required}
              onChange={(e) => onChange(e.target.value)} placeholder={placeholder}
              className="mt-1 w-full rounded-xl border border-neutral-200 bg-white px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500"
            />
          </label>
        );
      };
      const Select = ({ label, value, onChange, options, placeholder="Selecione..." , required }) => {
        const id = useMemo(() => Math.random().toString(36).slice(2), []);
        return (
          <label className="block">
            <span className="text-sm text-neutral-600">{label}</span>
            <select
              id={id} value={value} required={required}
              onChange={(e)=>onChange(e.target.value)}
              className="mt-1 w-full rounded-xl border border-neutral-200 bg-white px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500"
            >
              <option value="">{placeholder}</option>
              {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
            </select>
          </label>
        );
      };

      // ========== Views ==========
      function DashboardView({ store }) {
        const recMes = store.recebimentos.filter(r => sameYM(r.data));
        const venMes = store.vendas.filter(v => sameYM(v.data));
        const totalRecMes = recMes.reduce((s, x)=> s + Number(x.quantidade||0), 0);
        const receitaMes = venMes.reduce((s, x)=> s + Number(x.quantidade||0) * Number(x.precoUnit||0), 0);

        return (
          <section>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
              <StatCard title="Materiais" value={store.materiais.length} subtitle="Cadastrados" />
              <StatCard title="Associações" value={store.associacoes.length} subtitle="Ativas" />
              <StatCard title="Recebimentos (mês)" value={`${totalRecMes} ${store.materiais[0]?.unidade || "un"}`} subtitle="Somatório" />
              <StatCard title="Receita (mês)" value={money(receitaMes)} subtitle="Vendas" />
            </div>

            <Card className="p-6">
              <h3 className="text-lg font-semibold mb-2">Boas-vindas 👋</h3>
              <p className="text-neutral-600 text-sm leading-relaxed">
                Cadastre Materiais, Associações, registre Recebimentos e Vendas, e veja os <strong>Relatórios</strong> com somatórios e gráficos.
              </p>
              <div className="mt-4 inline-flex items-center px-3 py-2 rounded-xl text-sm border border-amber-200 bg-amber-50 text-amber-700">
                Teste
              </div>
            </Card>
          </section>
        );
      }

      function MateriaisView({ data, onCreate, onUpdate , onDelete }) {
        const [open, setOpen] = useState(false);
        const [nome, setNome] = useState(""), [categoria, setCategoria] = useState(""), [unidade, setUnidade] = useState("kg");
        const [busy, setBusy] = useState(false);
        const [editingId, setEditingId] = useState(null);
      
        const handleCloseDrawer = () => {
            setOpen(false);
            setBusy(false);
            // Limpa os campos
            setNome("");
            setCategoria("");
            setUnidade("kg"); // Reset para o padrão
            setEditingId(null); // Limpa o ID em edição!
        };
        const submit = async (e) => {
            e.preventDefault();
            setBusy(true);
            // Monta o payload com os dados atuais do formulário
            const payload = { nome, categoria, unidade };
            let success = false;

            try {
                if (editingId) {
                    // Chama onUpdate se estiver editando
                    success = await onUpdate(editingId, payload);
                } else {
                    // Chama onCreate se estiver criando
                    success = await onCreate(payload);
                }

                if (success) {
                    handleCloseDrawer();
                }
            } catch(error) {
                console.error("Falha no submit de material:", error);
            } finally {
                setBusy(false);
            }
        };
        const handleEdit = (materialParaEditar) => {
            setEditingId(materialParaEditar.id); // Guarda o ID
            // Preenche os estados do formulário
            setNome(materialParaEditar.nome || "");
            setCategoria(materialParaEditar.categoria || "");
            setUnidade(materialParaEditar.unidade_medida || "kg"); // Pega 'unidade_medida' da API
            setOpen(true); // Abre o Drawer
        };

        
        return (
          <section>
            <Toolbar>
              <h2 className="text-xl font-semibold">Materiais</h2>
              <button className="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white" onClick={()=>setOpen(true)}>+ Novo material</button>
            </Toolbar>

            <Table
              columns={[
                { key: "id", header: "ID" },
                { key: "nome", header: "Nome" },
                { key: "categoria", header: "Categoria" },
                { 
                    key: "estoque_atual",        // Acessa o novo campo vindo da API
                    header: "Estoque Atual",     // Novo título da coluna
                    // Função para formatar a exibição do estoque + unidade
                    render: (estoque, row) => 
                        // Mostra o estoque com 1 casa decimal (ou '-' se nulo/zero) 
                        // e a unidade_medida
                        `${estoque !== null && estoque !== undefined ? estoque.toFixed(1) : '-'} ${row.unidade_medida || 'un'}` 
                },
                {
                    key: "actions", header: "Ações", render: (_, row) => (
                        <div className="flex gap-2"> {/* Agrupa os botões */}
                            {/* Botão Editar */}
                            <button
                                className="px-2 py-1 rounded-lg border text-xs text-blue-600 border-blue-200 hover:bg-blue-50"
                                onClick={() => handleEdit(row)} // Chama a função de edição
                                title="Editar material"
                            >
                                ✏️ Editar
                            </button>
                            {/* Botão Remover (se você decidir reativar) */}
                            {/* <button className="..." onClick={()=>onDelete(row.id)} title="Remover material">🗑️ Remover</button> */}
                        </div>
                    )
                },
              ]}
              data={data}
              emptyLabel="Nenhum material cadastrado"
            />

            <Drawer open={open} onClose={()=>setOpen(false)} title="Adicionar Material">
              <form onSubmit={submit} className="space-y-3">
                <TextInput label="Nome" value={nome} onChange={setNome} placeholder="Ex: PET, Papelão" required />
                <TextInput label="Categoria" value={categoria} onChange={setCategoria} placeholder="Ex: Plástico, Papel" />
                <TextInput label="Unidade" value={unidade} onChange={setUnidade} placeholder="Ex: kg, un" />
                <div className="flex justify-end gap-2 pt-2">
                  <button type="button" className="px-4 py-2 rounded-xl border" onClick={()=>setOpen(false)}>Cancelar</button>
                  <button disabled={busy} className="px-4 py-2 rounded-xl bg-emerald-600 text-white disabled:opacity-60">{busy ? "Salvando..." : "Salvar"}</button>
                </div>
              </form>
            </Drawer>
          </section>
        );
      }

      function AssociacoesView({ data, onCreate, onUpdate , onDelete }) {
        const [open, setOpen] = useState(false);
        //const [nome, setNome] = useState(""), [cnpj, setCnpj] = useState(""), [contato, setContato] = useState("");
        const [nome, setNome] = useState(""), [cnpj, setCnpj] = useState("");
        const [lider, setLider] = useState(""), [telefone, setTelefone] = useState("");
        const [ativo, setAtivo] = useState(true);
        const [busy, setBusy] = useState(false);
        const [editingId, setEditingId] = useState(null);
        
      const submit = async (e) => {
          e.preventDefault();
          setBusy(true);
          // Monta o payload com os dados atuais do formulário
          const payload = { nome, cnpj, lider, telefone, ativo }; 
          let success = false;

          try {
              if (editingId) {
                  // Se estamos editando, chama onUpdate
                  success = await onUpdate(editingId, payload); 
              } else {
                  // Se não, chama onCreate
                  success = await onCreate(payload); 
              }

              if (success) { // Só fecha se a operação na App foi bem sucedida
                  handleCloseDrawer();
              }
          } catch(error) {
              // O erro já foi mostrado pelo alert na App
              console.error("Falha no submit:", error);
          } finally {
              setBusy(false);
          }
      };

      const handleEdit = (associacaoParaEditar) => {
          setEditingId(associacaoParaEditar.id); // Guarda o ID que estamos editando
          // Preenche os estados do formulário com os dados atuais
          setNome(associacaoParaEditar.nome);
          setLider(associacaoParaEditar.lider || ""); // Usa || "" para evitar undefined
          setTelefone(associacaoParaEditar.telefone || "");
          setCnpj(associacaoParaEditar.cnpj || "");
          setAtivo(associacaoParaEditar.ativo === true || associacaoParaEditar.ativo === 'true'); // Define o estado booleano
          setOpen(true);
      };
      const handleCloseDrawer = () => {
          setOpen(false);
          setBusy(false);
          // Limpa todos os campos
          setNome("");
          setLider("");
          setTelefone("");
          setCnpj("");
          setAtivo(true); 
          setEditingId(null); // Limpa o ID em edição!
      };

        return (
          <section>
            <Toolbar>
              <h2 className="text-xl font-semibold">Associações</h2>
              <button className="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white" onClick={()=>setOpen(true)}>+ Nova associação</button>
            </Toolbar>

            <Table
              columns={[
                { key: "id", header: "ID" },
                { key: "nome", header: "Nome" },
                { key: "cnpj", header: "CNPJ" },
                { key: "lider", header: "Líder" },
                { key: "telefone", header: "Telefone" },
                { 
                    key: "actions", header: "Ações", render: (_, row) => (
                        <div className="flex gap-2"> {/* Agrupa os botões */}
                            {/* Botão Editar */}
                            <button 
                                className="px-2 py-1 rounded-lg border text-xs text-blue-600 border-blue-200 hover:bg-blue-50"
                                onClick={() => handleEdit(row)} // Chama a função para abrir o form de edição
                                title="Editar associação"
                            >
                                ✏️ Editar
                            </button>
                            {/* Botão Remover (Inativar) */}
                            <button 
                                className="px-2 py-1 rounded-lg border text-xs text-red-600 border-red-200 hover:bg-red-50"
                                onClick={() => onDelete(row.id)} // Chama a função delete passada pela App
                                title="Inativar associação"
                            >
                                🗑️ Inativar
                            </button>
                        </div>
                    )
                },
                {
                    key: "ativo", // Usa a chave 'ativo'
                    header: "Status",
                    render: (isAtivo) => ( // Recebe o boolean
                        <span className={cls(
                            "px-2 py-0.5 rounded-full text-xs font-medium",
                            isAtivo ? "bg-emerald-100 text-emerald-800" : "bg-red-100 text-red-800"
                        )}>
                            {isAtivo ? "Ativa" : "Inativa"} {/* Mostra o texto com base no boolean */}
                        </span>
                    )
                },
              ]}
              data={data}
              emptyLabel="Nenhuma associação cadastrada"
            />

            <Drawer open={open} onClose={()=>setOpen(false)} title="Adicionar Associação">
              <form onSubmit={submit} className="space-y-3">
                <TextInput label="Nome" value={nome} onChange={setNome} placeholder="Ex: Associação Central" required />
                <TextInput label="CNPJ" value={cnpj} onChange={setCnpj} placeholder="00.000.000/0000-00" />
                <Select
                    label="Status"
                    value={ativo} // Ligado ao estado 'ativo'
                    onChange={(value) => setAtivo(value === 'true')} // Converte string 'true'/'false' para boolean
                    options={[
                        { value: true, label: "Ativa" }, // Valor é boolean true
                        { value: false, label: "Inativa" } // Valor é boolean false
                    ]}
                    required
                />
                <TextInput label="Nome do Líder/Responsável" value={lider} onChange={setLider} placeholder="Ex: João Silva" />
                <TextInput label="Telefone" value={telefone} onChange={setTelefone} placeholder="(85) 9...." />
                <div className="flex justify-end gap-2 pt-2">
                  <button type="button" className="px-4 py-2 rounded-xl border" onClick={()=>setOpen(false)}>Cancelar</button>
                  <button disabled={busy} className="px-4 py-2 rounded-xl bg-emerald-600 text-white disabled:opacity-60">{busy ? "Salvando..." : "Salvar"}</button>
                </div>
              </form>
            </Drawer>
          </section>
        );
      }

      function RecebimentosView({ store, setActive, onCreate, onCancel }) {
        const [open, setOpen] = useState(false);
        const [data, setData] = useState(todayISO());
        const [materialId, setMaterialId] = useState("");
        const [associacaoId, setAssociacaoId] = useState("");
        const [quantidade, setQuantidade] = useState("");
        const [busy, setBusy] = useState(false);

        const materiaisOpts = store.materiais.map(m => ({ value: String(m.id), label: m.nome }));
        const assocOpts = store.associacoes.map(a => ({ value: String(a.id), label: a.nome }));

        const onSubmit = async (e) => {
          e.preventDefault();
          if (!store.materiais.length) { alert("Cadastre materiais primeiro."); setActive("materiais"); return; }
          if (!store.associacoes.length) { alert("Cadastre associações primeiro."); setActive("associacoes"); return; }
          setBusy(true); await new Promise(r=>setTimeout(r,200));
          onCreate({
            
            materialId: Number(materialId),
            associacaoId: Number(associacaoId),
            quantidade: parseFloat(quantidade || "0"),
          });
          setData(todayISO()); setMaterialId(""); setAssociacaoId(""); setQuantidade(""); setOpen(false); setBusy(false);
        };

        const getMat = (id) => store.materiais.find(m => m.id === id);
        const getAsc = (id) => store.associacoes.find(a => a.id === id);

        const total = store.recebimentos.reduce((s,x)=> s + Number(x.quantidade||0), 0);

        return (
          <section>
            <Toolbar>
              <h2 className="text-xl font-semibold">Recebimentos</h2>
              <div className="flex gap-2">
                <button className="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white" onClick={()=>setOpen(true)}>+ Novo recebimento</button>
              </div>
            </Toolbar>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <StatCard title="Entradas registradas" value={store.recebimentos.length} />
              <StatCard title="Total recebido" value={`${total} ${store.materiais[0]?.unidade || "un"}`} />
              <Card className="p-5">
                <div className="text-sm text-neutral-500">Ações rápidas</div>
                <div className="mt-2 flex gap-2">
                  <button className="px-3 py-1.5 rounded-lg border text-sm" onClick={()=>setActive("materiais")}>+ Material</button>
                  <button className="px-3 py-1.5 rounded-lg border text-sm" onClick={()=>setActive("associacoes")}>+ Associação</button>
                </div>
              </Card>
            </div>

            <Table
              columns={[
                { key: "data", header: "Data", render: v => fmtDateBR(v) },
                //{ key: "materialId", header: "Material", render: v => getMat(v)?.nome || "-" },
                //{ key: "associacaoId", header: "Associação", render: v => getAsc(v)?.nome || "-" },
                 { key: "material", header: "Material", render: (_, row) => row.material.nome },
                { key: "associacao", header: "Associação", render: (_, row) => row.associacao.nome },
                
                { key: "quantidade", header: "Quantidade", render: (v, row) => `${v} ${row.material?.unidade_medida || ""}` },
                { key: "actions", header: "Ações", render: (_, row) => (
                        // 👇 Adiciona botão Cancelar 👇
                        <button className="px-2 py-1 rounded-lg border text-xs text-orange-600 border-orange-200 hover:bg-orange-50"
                                onClick={()=>onCancel(row.id)} title="Cancelar recebimento">
                            🚫 Cancelar
                        </button>
                    )},
              ]}
              data={store.recebimentos}
              emptyLabel="Nenhum recebimento cadastrado"
            />

            <Drawer open={open} onClose={()=>setOpen(false)} title="Adicionar Recebimento">
              <form onSubmit={onSubmit} className="space-y-3">
                <TextInput label="Data" type="date" value={data} onChange={setData} required />
                <Select label="Material" value={materialId} onChange={setMaterialId} options={materiaisOpts} required />
                <Select label="Associação" value={associacaoId} onChange={setAssociacaoId} options={assocOpts} required />
                <TextInput label="Quantidade" type="number" value={quantidade} onChange={setQuantidade} placeholder="Ex: 120" required />
                <div className="flex justify-end gap-2 pt-2">
                  <button type="button" className="px-4 py-2 rounded-xl border" onClick={()=>setOpen(false)}>Cancelar</button>
                  <button disabled={busy} className="px-4 py-2 rounded-xl bg-emerald-600 text-white disabled:opacity-60">{busy ? "Salvando..." : "Salvar"}</button>
                </div>
              </form>
            </Drawer>
          </section>
        );
      }

      function VendasView({ store, setActive, onCreate, onCancel }) {
    const [open, setOpen] = useState(false);
    const [busy, setBusy] = useState(false);
    const [dataVenda, setDataVenda] = useState(todayISO());
    const [comprador, setComprador] = useState("");
    const [itemAtualMaterialId, setItemAtualMaterialId] = useState("");
    const [itemAtualQuantidade, setItemAtualQuantidade] = useState("");
    const [itemAtualPrecoUnit, setItemAtualPrecoUnit] = useState("");
    const [estoqueDisponivel, setEstoqueDisponivel] = useState(null);
    const [itens, setItens] = useState([]);

    const materiaisOpts = store.materiais.map(m => ({ value: String(m.id), label: m.nome }));


    const getMat = (id) => store.materiais.find(m => m.id === Number(id));

    useEffect(() => {
        const fetchEstoque = async () => {
            if (itemAtualMaterialId && !isNaN(Number(itemAtualMaterialId))) {
                try {
                    setEstoqueDisponivel(null);
                    console.log(API_URL)
                    const response = await fetch(`${API_URL}/estoque/${itemAtualMaterialId}`);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Falha ao buscar estoque');
                    }
                    const data = await response.json();
                    setEstoqueDisponivel(data);
                } catch (error) {
                    console.error("Erro ao buscar estoque:", error.message);
                    setEstoqueDisponivel(null);
                }
            } else {
                setEstoqueDisponivel(null);
            }
        };
        fetchEstoque();
    }, [itemAtualMaterialId]);

    useEffect(() => {
        if (store.vendas && store.vendas.length > 0) {
            console.log("--- Estrutura de store.vendas recebida da API ---");
            console.log(JSON.stringify(store.vendas, null, 2));
        } else {
            console.log("store.vendas ainda está vazio ou não definido.");
        }
    }, [store.vendas]);

    const handleAddItem = () => {
        if (!itemAtualMaterialId || !itemAtualQuantidade || !itemAtualPrecoUnit) {
            alert("Preencha Material, Quantidade e Preço Unitário para adicionar.");
            return;
        }
        const qtdNum = parseFloat(itemAtualQuantidade || "0");
        const precoNum = parseFloat(itemAtualPrecoUnit || "0");
        if (isNaN(qtdNum) || qtdNum <= 0 || isNaN(precoNum) || precoNum <= 0) {
            alert("Quantidade e Preço Unitário devem ser números positivos.");
            return;
        }
        if (estoqueDisponivel && qtdNum > estoqueDisponivel.estoque_atual) {
            alert(`Estoque insuficiente. Disponível: ${estoqueDisponivel.estoque_atual} ${estoqueDisponivel.unidade_medida}`);
            return;
        }

        const novoItem = {
            id_material: Number(itemAtualMaterialId),
            quantidade_vendida: qtdNum,
            valor_unitario: precoNum
        };
        setItens(listaAnterior => [...listaAnterior, novoItem]);

        setItemAtualMaterialId("");
        setItemAtualQuantidade("");
        setItemAtualPrecoUnit("");
        setEstoqueDisponivel(null);
    };

    const handleRemoveItem = (indexParaRemover) => {
        setItens(listaAnterior => listaAnterior.filter((_, index) => index !== indexParaRemover));
    };

    const handleCloseDrawer = () => {
        setOpen(false);
        setBusy(false);
        setDataVenda(todayISO());
        setComprador(""); // Correção
        setItens([]);
        setItemAtualMaterialId("");
        setItemAtualQuantidade("");
        setItemAtualPrecoUnit("");
        setEstoqueDisponivel(null);
    };

    const handleSubmitVenda = async () => {
        if (!comprador) {
            alert("Informe o nome do comprador.");
            return;
        }
        if (itens.length === 0) {
            alert("Adicione pelo menos um item à venda.");
            return;
        }

        setBusy(true);
        try {
            await onCreate({
                comprador: comprador, // Correção: Envia 'nomeComprador'
                itens: itens
            });
            handleCloseDrawer();
        } catch (error) {
           // O erro já é tratado na função `createVenda` da App
        } finally {
            setBusy(false);
        }
    };

    const totalQtdVendida = store.vendas.reduce((totalVendas, venda) =>
        totalVendas + venda.itens.reduce((totalItens, item) =>
            totalItens + Number(item.quantidade_vendida || 0), 0),
    0);

    const receitaTotal = store.vendas.reduce((totalVendas, venda) =>
        totalVendas + venda.itens.reduce((totalItens, item) =>
            totalItens + (Number(item.quantidade_vendida || 0) * Number(item.valor_unitario || 0)), 0),
    0);

    const itensVendidosData = useMemo(() => {
        return store.vendas.flatMap(venda =>
            venda.itens.map(item => ({
                ...item,
                venda_id: venda.id,
                data_venda: venda.data_venda,
                codigo: venda.id, // Correção
                comprador: venda.comprador, // Correção
            }))
        ).sort((a, b) => new Date(b.data_venda) - new Date(a.data_venda));
    }, [store.vendas]);

    return (
        <section>
            <Toolbar>
                <h2 className="text-xl font-semibold">Vendas</h2>
                <button className="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white" onClick={()=>setOpen(true)}>+ Nova venda</button>
            </Toolbar>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <StatCard title="Vendas registradas" value={store.vendas.length} />
                <StatCard title="Quantidade vendida (Total)" value={`${totalQtdVendida.toFixed(2)} un`} />
                <StatCard title="Receita total" value={money(receitaTotal)} />
            </div>

            <Table
                columns={[
                    { key: "data_venda", header: "Data", render: v => fmtDateBR(v) },
                    { key: "codigo", header: "Cód. Venda" },
                    { key: "comprador", header: "Comprador" }, // Correção
                    { key: "material", header: "Material", render: (mat) => mat?.nome || "-" },
                    { key: "quantidade_vendida", header: "Quantidade", render: (v, row) => `${v} ${row.material?.unidade_medida || "un"}` },
                    { key: "valor_unitario", header: "Preço Unit.", render: v => money(v) },
                    { key: "total", header: "Total Item", render: (_, row) => money(Number(row.quantidade_vendida || 0) * Number(row.valor_unitario || 0)) },
                    { key: "actions", header: "Ações", render: (_, row) => (
                         // 👇 Adiciona botão Cancelar 👇
                        <button className="px-2 py-1 rounded-lg border text-xs text-orange-600 border-orange-200 hover:bg-orange-50"
                                onClick={() => onCancel(row.venda_id)}
                                title="Cancelar venda completa">
                            🚫 Cancelar Venda
                        </button>
                    )},
                ]}
                data={itensVendidosData}
                emptyLabel="Nenhuma venda registrada"
            />

            <Drawer open={open} onClose={handleCloseDrawer} title="Registrar Nova Venda">
                <div className="space-y-4">
                    <TextInput label="Data" type="date" value={dataVenda} onChange={setDataVenda} required />
                    <TextInput label="Nome do Comprador" value={comprador} onChange={setComprador} placeholder="Ex: Recicla Brasil Ltda" required />
                    <hr className="my-4"/>
                    <h4 className="font-medium text-neutral-700">Adicionar Item</h4>
                    <div className="grid grid-cols-3 gap-2 p-3 border rounded-lg bg-neutral-50">
                        <div className="col-span-3">
                            <Select
                                label="Material"
                                value={itemAtualMaterialId}
                                onChange={setItemAtualMaterialId}
                                options={materiaisOpts}
                                required={itens.length === 0}
                            />
                            {estoqueDisponivel && (
                                <p className="text-xs text-emerald-700 mt-1">
                                    Disponível: {estoqueDisponivel.estoque_atual} {estoqueDisponivel.unidade_medida}
                                </p>
                            )}
                            {!itemAtualMaterialId && <p className="text-xs text-neutral-400 mt-1">Selecione um material para ver o estoque.</p>}
                        </div>
                        <TextInput
                            label="Qtd" type="number" value={itemAtualQuantidade}
                            onChange={(value) => setItemAtualQuantidade(value)}
                            placeholder="Kg" required={itens.length === 0}
                        />
                        <TextInput label="Preço Unit (R$)" type="number" value={itemAtualPrecoUnit} onChange={setItemAtualPrecoUnit} placeholder="Ex: 2.5" required={itens.length === 0}/>
                        <div className="flex items-end">
                            <button
                                type="button"
                                onClick={handleAddItem}
                                disabled={!itemAtualMaterialId || !itemAtualQuantidade || !itemAtualPrecoUnit || parseFloat(itemAtualQuantidade || '0') <= 0 || parseFloat(itemAtualPrecoUnit || '0') <= 0 || (estoqueDisponivel === null && itemAtualMaterialId !== "") || (estoqueDisponivel && parseFloat(itemAtualQuantidade || '0') > estoqueDisponivel.estoque_atual)}
                                className="w-full px-3 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                + Adicionar
                            </button>
                        </div>
                        {estoqueDisponivel && parseFloat(itemAtualQuantidade || '0') > estoqueDisponivel.estoque_atual && (
                            <p className="text-xs text-red-600 col-span-3 mt-1">
                                Quantidade maior que o estoque disponível!
                            </p>
                        )}
                    </div>
                    <hr className="my-4"/>
                    <h4 className="font-medium text-neutral-700">Itens da Venda ({itens.length})</h4>
                    {itens.length === 0 ? (
                        <p className="text-sm text-neutral-500 text-center py-4">Nenhum item adicionado ainda.</p>
                    ) : (
                        <ul className="space-y-2 max-h-40 overflow-y-auto border rounded-lg p-2 bg-neutral-50">
                            {itens.map((item, index) => {
                                const materialInfo = getMat(item.id_material);
                                return (
                                    <li key={index} className="flex justify-between items-center text-sm p-2 bg-white rounded shadow-sm">
                                        <span>
                                            {item.quantidade_vendida} {materialInfo?.unidade_medida || 'un'} de {materialInfo?.nome || '?'}
                                            @ {money(item.valor_unitario)}
                                        </span>
                                        <button
                                            onClick={() => handleRemoveItem(index)}
                                            className="text-red-500 hover:text-red-700 font-bold"
                                            title="Remover Item"
                                        >
                                            &times;
                                        </button>
                                    </li>
                                );
                            })}
                        </ul>
                    )}
                    <div className="flex justify-end gap-2 pt-4">
                        <button type="button" className="px-4 py-2 rounded-xl border" onClick={handleCloseDrawer}>Cancelar</button>
                        <button
                            type="button"
                            onClick={handleSubmitVenda}
                            disabled={busy || itens.length === 0 || !comprador}
                            className="px-4 py-2 rounded-xl bg-emerald-600 text-white disabled:opacity-60"
                        >
                            {busy ? "Salvando..." : "Finalizar Venda"}
                        </button>
                    </div>
                </div>
            </Drawer>
        </section>
    );
}

    function RelatoriosView({ store }) { // Removi onRemoveRange por enquanto
        const [start, setStart] = useState("");
        const [end, setEnd] = useState("");

        // --- Estados para guardar os dados da API ---
        const [summaryData, setSummaryData] = useState({ total_recebido: 0, total_vendido: 0, receita_periodo: 0 });
        const [porMaterialData, setPorMaterialData] = useState([]);
        const [porAssociacaoData, setPorAssociacaoData] = useState([]);
        const [loading, setLoading] = useState(false); // Estado de carregamento

        //const API_URL = "http://127.0.0.1:8000"; // Confirme se está acessível

        // --- useEffect para buscar dados quando as datas mudam ---
        useEffect(() => {
            const fetchDataForReports = async () => {
                setLoading(true);
                console.log(`Buscando relatórios para período: ${start || 'inicio'} a ${end || 'fim'}`);
                try {
                    const params = new URLSearchParams();
                    if (start) params.append('start_date', start);
                    if (end) params.append('end_date', end);
                    const queryString = params.toString();

                    const [summaryRes, porMaterialRes, porAssocRes] = await Promise.all([
                        fetch(`${API_URL}/relatorio/relatorio?${queryString}`),
                        fetch(`${API_URL}/relatorio/por-material?${queryString}`),
                        fetch(`${API_URL}/relatorio/por-associacao?${queryString}`)
                    ]);

                    // Tratamento de erro mais robusto
                    if (!summaryRes.ok) { throw new Error(`Erro Sumário: ${summaryRes.statusText}`); }
                    if (!porMaterialRes.ok) { throw new Error(`Erro Por Material: ${porMaterialRes.statusText}`); }
                    if (!porAssocRes.ok) { throw new Error(`Erro Por Associação: ${porAssocRes.statusText}`); }

                    const summaryJson = await summaryRes.json();
                    const porMaterialJson = await porMaterialRes.json();
                    const porAssocJson = await porAssocRes.json();

                    console.log("Dados recebidos (Sumário):", summaryJson);
                    console.log("Dados recebidos (Por Material):", porMaterialJson);
                    console.log("Dados recebidos (Por Associação):", porAssocJson);

                    setSummaryData(summaryJson);
                    setPorMaterialData(porMaterialJson);
                    setPorAssociacaoData(porAssocJson);

                } catch (error) {
                    console.error("Erro ao buscar dados dos relatórios:", error);
                    alert(`Erro ao carregar relatórios: ${error.message}. Verifique o console e o backend.`);
                    // Limpa os dados em caso de erro para evitar mostrar dados antigos
                    setSummaryData({ total_recebido: 0, total_vendido: 0, receita_periodo: 0 });
                    setPorMaterialData([]);
                    setPorAssociacaoData([]);
                } finally {
                    setLoading(false);
                }
            };

            fetchDataForReports();
        }, [start, end]); // Depende das datas

        // --- Lógica dos Gráficos (usa os dados do estado) ---
        const recChartRef = useRef(null), recChartInstance = useRef(null);
        const revChartRef = useRef(null), revChartInstance = useRef(null);

        useEffect(() => {
            if (!window.Chart || porMaterialData.length === 0) return; // Só roda se tiver Chart e dados

            const recLabels = porMaterialData.map(m => m.nome);
            const recData = porMaterialData.map(m => m.recebido);
            const revLabels = porMaterialData.map(m => m.nome);
            const revData = porMaterialData.map(m => m.receita);

            // Destroi gráficos antigos antes de criar novos
            if (recChartInstance.current) recChartInstance.current.destroy();
            if (revChartInstance.current) revChartInstance.current.destroy();

            if (recChartRef.current) {
                recChartInstance.current = new Chart(recChartRef.current, {
                    type: "bar",
                    data: { labels: recLabels, datasets: [{ label: "Recebido (Kg)", data: recData, backgroundColor: 'rgba(75, 192, 192, 0.6)' }] }, // Exemplo de cor
                    options: { responsive: true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
                });
            }
            if (revChartRef.current) {
                revChartInstance.current = new Chart(revChartRef.current, {
                    type: "bar",
                    data: { labels: revLabels, datasets: [{ label: "Receita (R$)", data: revData, backgroundColor: 'rgba(54, 162, 235, 0.6)' }] }, // Exemplo de cor
                    options: { responsive: true, plugins:{ legend:{display:false} },
                        scales:{ y:{ beginAtZero:true, ticks:{ callback:(v)=> money(v) } } } }
                });
            }
            // Função de limpeza para destruir os gráficos quando o componente desmontar ou os dados mudarem
            return () => {
                if (recChartInstance.current) recChartInstance.current.destroy();
                if (revChartInstance.current) revChartInstance.current.destroy();
            };
        }, [porMaterialData]); // Depende apenas dos dados por material


        // (Função removePeriodo removida/comentada por enquanto)
        // const removePeriodo = () => { /* ... lógica futura ... */ };

        return (
            <section>
                <Toolbar>
                    <h2 className="text-xl font-semibold">Relatórios</h2>
                    <div className="flex flex-wrap gap-2 items-end"> {/* Use flex-wrap */}
                        <TextInput label="Início" type="date" value={start} onChange={setStart}/>
                        <TextInput label="Fim" type="date" value={end} onChange={setEnd}/>
                        <button className="px-3 py-2 rounded-xl border bg-white" onClick={()=>{ setStart(""); setEnd(""); }}>Limpar Datas</button>
                        {/* Botão Remover período comentado/removido
                        <button className="..." onClick={removePeriodo} title="Remover dados do período">
                            🗑️ Remover período
                        </button>
                        */}
                    </div>
                </Toolbar>

                {/* Indicador de Carregamento */}
                {loading && <div className="text-center p-4 text-emerald-600">Carregando relatórios...</div>}

                {/* Cards de Resumo (usam summaryData) */}
                {!loading && (
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <StatCard title="Total recebido" value={`${summaryData.total_recebido.toFixed(1)} Kg`} subtitle="No período selecionado"/>
                        <StatCard title="Total vendido" value={`${summaryData.total_vendido.toFixed(1)} Kg`} subtitle="No período selecionado"/>
                        <StatCard title="Receita no período" value={money(summaryData.receita_periodo)} />
                    </div>
                )}

                {/* Gráficos */}
                {!loading && (
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <Card className="p-6">
                            <div className="text-sm text-neutral-500 mb-2">Recebidos por Material (Kg)</div>
                            <canvas ref={recChartRef} height="140"></canvas>
                            {porMaterialData.length === 0 && !loading && <div className="text-neutral-400 text-sm mt-4 text-center">Sem dados de recebimento no período.</div>}
                        </Card>
                        <Card className="p-6">
                            <div className="text-sm text-neutral-500 mb-2">Receita por Material (R$)</div>
                            <canvas ref={revChartRef} height="140"></canvas>
                            {porMaterialData.length === 0 && !loading && <div className="text-neutral-400 text-sm mt-4 text-center">Sem dados de receita no período.</div>}
                        </Card>
                    </div>
                )}

                {/* Tabelas */}
                {!loading && (
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Tabela Resumo por Material (usa porMaterialData) */}
                        <Card className="p-6">
                            <div className="text-sm text-neutral-500 mb-3">Resumo por Material</div>
                            <Table
                                columns={[
                                    { key: "nome", header: "Material" },
                                    { key: "recebido", header: "Recebido" , render:(v,row)=> `${v.toFixed(1)} ${row.unidade_medida}` },
                                    { key: "vendido", header: "Vendido" , render:(v,row)=> `${v.toFixed(1)} ${row.unidade_medida}` },
                                    { key: "saldo", header: "Saldo" , render:(v,row)=> `${v.toFixed(1)} ${row.unidade_medida}` },
                                    { key: "receita", header: "Receita" , render: v => money(v) },
                                ]}
                                data={porMaterialData}
                                emptyLabel="Sem dados no período"
                            />
                        </Card>
                        {/* Tabela Recebido por Associação (usa porAssociacaoData) */}
                        <Card className="p-6">
                            <div className="text-sm text-neutral-500 mb-3">Recebido por Associação (Kg)</div>
                            <Table
                                columns={[
                                    { key: "nome", header: "Associação" },
                                    { key: "quantidade", header: "Quantidade Total", render: (v)=> v.toFixed(1) + ' Kg' },
                                ]}
                                data={porAssociacaoData}
                                emptyLabel="Sem recebimentos no período"
                            />
                        </Card>
                    </div>
                )}
            </section>
        );
    }
      // ========== App ==========
      function App() {
        const API_URL = "http://127.0.0.1:8000"

        const [active, setActive] = useState("dashboard");
        //const [store, setStore] = useState(() => load());
        const [store,setStore] = useState({
          materiais: [],
          associacoes: [],
          recebimentos: [],
          vendas : []
        })
        
        //useEffect(()=> save(store), [store]);

        useEffect(() => {
          const fetchAllData = async () => {
            console.log("Buscando dados iniciais da API...")

            try{
              // Fazemos todas as chamadas de listagem em paralelo para ser mais rápido
            const [estoqueMaterialResponse, associacoesResponse, entradasResponse,vendasResponse] = await Promise.all([
                //fetch(`${API_URL}/materiais/`),
                fetch(`${API_URL}/estoque/`),
                fetch(`${API_URL}/associacoes/`),
                fetch(`${API_URL}/entradas_material/`),
                fetch(`${API_URL}/vendas/`)
                // Adicione aqui o fetch para /vendas/ quando o endpoint estiver pronto
            ]);
            if (!estoqueMaterialResponse.ok) throw new Error(`Falha ao buscar estoque: ${estoqueMateriaisResponse.statusText}`);
            if (!associacoesResponse.ok) throw new Error(`Falha ao buscar associações: ${associacoesResponse.statusText}`);
            if (!entradasResponse.ok) throw new Error(`Falha ao buscar entradas: ${entradasResponse.statusText}`);
            if (!vendasResponse.ok) throw new Error(`Falha ao buscar vendas: ${vendasResponse.statusText}`);

            // Convertemos as respostas para JSON
            const estoqueMateriaisData = await estoqueMaterialResponse.json();
            const associacoesData = await associacoesResponse.json();
            const entradasData = await entradasResponse.json();
            const vendasData = await vendasResponse.json()

            // ATUALIZAMOS O ESTADO com os dados recebidos da API
            setStore(currentState => ({
                ...currentState, // Mantém o que já estava no store (ex: vendas, se não foi buscado)
                materiais: estoqueMateriaisData,
                associacoes: associacoesData,
                recebimentos: entradasData,
                vendas: vendasData
            }));
            console.log("Dados carregados com sucesso!");
            }
            catch (error){
              console.error("Falha ao carregar dados da API:", error);
              alert("Não foi possível conectar ao servidor. Verifique se o backend está rodando e se o CORS está configurado.");
            }
          }
          fetchAllData()
        }, [])

        // CREATE
        //const createMaterial = (payload) => setStore(s => ({ ...s, materiais: [...s.materiais, { id: nextId(s.materiais), ...payload }] }));
        //const createAssociacao = (payload) => setStore(s => ({ ...s, associacoes: [...s.associacoes, { id: nextId(s.associacoes), ...payload }] }));
        //const createRecebimento = (payload) => setStore(s => ({ ...s, recebimentos: [...s.recebimentos, { id: nextId(s.recebimentos), ...payload }] }));
        //const createVenda = (payload) => setStore(s => ({ ...s, vendas: [...s.vendas, { id: nextId(s.vendas), ...payload }] }));
        const createMaterial = async (payload) => {
    // AJUSTE: O backend espera 'unidade_medida', não 'unidade'.
    const payloadParaAPI = {
          nome: payload.nome,
          unidade_medida: payload.unidade,
          categoria: payload.categoria
      };

      try {
          const response = await fetch(`${API_URL}/materiais/`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payloadParaAPI)
          });

          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.detail || "Falha ao criar material");
          }

          const novoMaterialCriado = await response.json();
          setStore(s => ({ ...s, materiais: [...s.materiais, novoMaterialCriado] }));
      } catch (error) {
          console.error("Erro ao criar material:", error);
          alert(`Erro: ${error.message}`);
      }
  };

  const createAssociacao = async (payload) => {
      // AJUSTE: O backend espera 'lider' e 'telefone', não 'contato'.
      // Vamos mapear os campos corretamente.
      const payloadParaAPI = {
          nome: payload.nome,
          lider: payload.lider, // O backend espera 'lider', o front envia 'contato'
          telefone: payload.telefone, // Usando o campo 'contato' para 'telefone'
          cnpj: payload.cnpj
      };

      try {
          const response = await fetch(`${API_URL}/associacoes/`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payloadParaAPI)
          });
          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.detail || "Falha ao criar associação");
          }
          const novaAssociacaoCriada = await response.json();
          setStore(s => ({ ...s, associacoes: [...s.associacoes, novaAssociacaoCriada] }));
      } catch (error) {
          console.error("Erro ao criar associação:", error);
          alert(`Erro: ${error.message}`);
      }
  };

  const createRecebimento = async (payload) => {
      // AJUSTE: Mapear os nomes dos campos do frontend para o backend
      const payloadParaAPI = {
          quantidade: payload.quantidade,
          id_material: payload.materialId,
          id_associacao: payload.associacaoId
      };
      console.log("Enviando para API:", JSON.stringify(payloadParaAPI, null, 2));
      try {
          const response = await fetch(`${API_URL}/entradas_material/`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payloadParaAPI)
          });
          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.detail || "Falha ao registrar recebimento");
          }
          const novoRecebimento = await response.json();
          setStore(s => ({ ...s, recebimentos: [...s.recebimentos, novoRecebimento] }));
      } catch (error) {
          console.error("Erro ao criar recebimento:", error);
          alert(`Erro: ${error.message}`);
      }
  };

  const createVenda = async (payload) => {
      // AJUSTE CRÍTICO: O frontend envia uma venda simples, o backend espera uma complexa.
      // Vamos montar o objeto que o backend espera.
      const payloadParaAPI = {
          comprador: payload.comprador, // ATENÇÃO: Usando comprador com ID 1 fixo por enquanto.
          concluida: true,
          itens : payload.itens
      };
      console.log("Enviando para API:", JSON.stringify(payloadParaAPI, null, 2));


      try {
          const response = await fetch(`${API_URL}/vendas/`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payloadParaAPI)
          });
          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.detail || "Falha ao registrar venda");
          }
          const novaVenda = await response.json();
          setStore(s => ({ ...s, vendas: [...s.vendas, novaVenda] }));
      } catch (error) {
          console.error("Erro ao criar venda:", error);
          alert(`Erro: ${error.message}`);
      }
  };


        // DELETE (com confirmação)
        //const deleteMaterial = (id) => {
         // if (!confirm("Remover MATERIAL e todos os recebimentos/vendas ligados a ele?")) return;
          //setStore(s => ({
           // ...s,
            //materiais: s.materiais.filter(m => m.id !== id),
            //recebimentos: s.recebimentos.filter(r => r.materialId !== id),
            //vendas: s.vendas.filter(v => v.materialId !== id),
          //}));
        //};
        const deleteMaterial = async (id) => {
            if (!confirm("Remover MATERIAL? Esta ação não pode ser desfeita.")) return;
            try {
                        const response = await fetch(`${API_URL}/materiais/${id}`, { method: 'DELETE' }); // Supondo que você crie o endpoint de DELETE
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || "Falha ao remover material");
                        }
                        // Se a remoção no backend deu certo, removemos do estado local
                        setStore(s => ({
                            ...s,
                            materiais: s.materiais.filter(m => m.id !== id)
                        }));
                    } catch (error) {
                        console.error("Erro ao remover material:", error);
                        alert(`Erro: ${error.message}`);
                    }
                };
                const deleteAssociacao = async (id) => {
          // A confirmação agora fica aqui, antes da chamada da API
              if (!confirm("Tem certeza que deseja INATIVAR esta associação? Ela não aparecerá mais nas listas, mas o histórico será mantido.")) {
                  return false; // Usuário cancelou
              }

              try {
                  const response = await fetch(`${API_URL}/associacoes/${id}`, { 
                      method: 'DELETE' 
                  });
                  
                  // Verifica se a resposta foi 204 No Content (sucesso) ou outro erro
                  if (response.status === 204) {
                      // Se a inativação no backend deu certo, removemos do estado local
                      // pois a lista principal (get_all_associacoes) só retorna ativos
                      setStore(s => ({
                          ...s,
                          associacoes: s.associacoes.filter(a => a.id !== id) 
                      }));
                      return true; // Sucesso
                  } else {
                      // Se deu erro (404, 500, etc.)
                      const errorData = await response.json();
                      throw new Error(errorData.detail || "Falha ao inativar associação");
                  }

              } catch (error) {
                  console.error("Erro ao inativar associação:", error);
                  alert(`Erro: ${error.message}`);
                  return false; // Falha
              }
          };
        const deleteRecebimento = (id) => {
          if (!confirm("Remover este RECEBIMENTO?")) return;
          setStore(s => ({ ...s, recebimentos: s.recebimentos.filter(r => r.id !== id) }));
        };
        const deleteVenda = (id) => {
          if (!confirm("Remover esta VENDA?")) return;
          setStore(s => ({ ...s, vendas: s.vendas.filter(v => v.id !== id) }));
        };
        const removeRange = (start, end) => {
          setStore(s => ({
            ...s,
            recebimentos: s.recebimentos.filter(r => !inRange(r.data, start, end)),
            vendas: s.vendas.filter(v => !inRange(v.data, start, end)),
          }));
        };

        const cancelEntrada = async (id) => { // Cancela Entrada
            if (!confirm("Tem certeza que deseja CANCELAR este recebimento? O estoque será recalculado.")) return false;
            try {
                const response = await fetch(`${API_URL}/entradas_material/${id}`, { method: 'DELETE' });
                if (response.status === 204) {
                    setStore(s => ({ ...s, recebimentos: s.recebimentos.filter(r => r.id !== id) }));
                    // Opcional: Forçar recálculo do estoque buscando materiais novamente
                    // fetchAllData(); // Ou uma função mais específica
                    return true;
                } else { const d = await response.json(); throw new Error(d.detail || "Erro"); }
            } catch (error) { console.error("Erro cancelar recebimento:", error); alert(`Erro: ${error.message}`); return false; }
        };

        const cancelVenda = async (id) => { // Cancela Venda
            if (!confirm("Tem certeza que deseja CANCELAR esta venda? O estoque será recalculado.")) return false;
            try {
                const response = await fetch(`${API_URL}/vendas/${id}`, { method: 'DELETE' });
                if (response.status === 204) {
                    setStore(s => ({ ...s, vendas: s.vendas.filter(v => v.id !== id) }));
                    // Opcional: Forçar recálculo do estoque
                    return true;
                } else { const d = await response.json(); throw new Error(d.detail || "Erro"); }
            } catch (error) { console.error("Erro cancelar venda:", error); alert(`Erro: ${error.message}`); return false; }
        };
        const updateAssociacao = async (id, payload) => {
              // Monta o payload para a API (já deve estar correto vindo da AssociacoesView)
              const payloadParaAPI = { ...payload }; 

              try {
                  const response = await fetch(`${API_URL}/associacoes/${id}`, {
                      method: 'PUT',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify(payloadParaAPI)
                  });
                  if (!response.ok) {
                      const errorData = await response.json();
                      throw new Error(errorData.detail || "Falha ao atualizar associação");
                  }
                  const associacaoAtualizada = await response.json();
                  
                  // Atualiza o estado local substituindo o item antigo pelo novo
                  setStore(s => ({ 
                      ...s, 
                      associacoes: s.associacoes.map(a => a.id === id ? associacaoAtualizada : a) 
                  }));
                  
                  // Retorna sucesso (opcional, mas útil para o submit)
                  return true; 

              } catch (error) {
                  console.error("Erro ao atualizar associação:", error);
                  alert(`Erro: ${error.message}`);
                  return false; // Retorna falha
              }
        };
        const updateMaterial = async (id, payload) => {
            // Monta o payload para a API traduzindo 'unidade' para 'unidade_medida'
            const payloadParaAPI = {
                nome: payload.nome,
                categoria: payload.categoria,
                unidade_medida: payload.unidade // Tradução
            };

            try {
                const response = await fetch(`${API_URL}/materiais/${id}`, { // Usa o ID na URL
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payloadParaAPI)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || "Falha ao atualizar material");
                }
                const materialAtualizado = await response.json();

                // Atualiza o estado local substituindo o item antigo pelo novo
                setStore(s => ({
                    ...s,
                    materiais: s.materiais.map(m => m.id === id ? materialAtualizado : m)
                }));

                return true; // Indica sucesso

            } catch (error) {
                console.error("Erro ao atualizar material:", error);
                alert(`Erro: ${error.message}`);
                return false; // Indica falha
            }
        };

        return (
          <div className="min-h-screen">
            {/* Topbar */}
            <header className="backdrop-blur bg-white/70 border-b border-black/5 sticky top-0 z-40">
              <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
                <div className="w-9 h-9 rounded-2xl bg-emerald-600 grid place-items-center text-white font-bold">RC</div>
                <div className="flex-1">
                  <div className="font-semibold leading-tight">Rede de Catadores – Gestão</div>
                  <div className="text-xs text-neutral-500">Teste</div>
                </div>
                <span className="text-xs px-3 py-1.5 rounded-xl border border-amber-200 bg-amber-50 text-amber-700">Teste</span>
              </div>
            </header>

            {/* Layout */}
            <div className="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-[240px,1fr] gap-6 px-4 py-6">
              {/* Sidebar */}
              <aside className="md:sticky md:top-16 h-max">
                <nav className="bg-white/80 rounded-2xl border border-black/5 shadow-sm p-3">
                  <div className="text-xs uppercase tracking-wide text-neutral-500 px-2 pb-2">Navegação</div>
                  <div className="flex flex-wrap md:flex-col gap-2">
                    <Pill active={active === "dashboard"} onClick={()=>setActive("dashboard")}>Dashboard</Pill>
                    <Pill active={active === "materiais"} onClick={()=>setActive("materiais")}>Materiais</Pill>
                    <Pill active={active === "associacoes"} onClick={()=>setActive("associacoes")}>Associações</Pill>
                    <Pill active={active === "recebimentos"} onClick={()=>setActive("recebimentos")}>Recebimentos</Pill>
                    <Pill active={active === "vendas"} onClick={()=>setActive("vendas")}>Vendas</Pill>
                    <Pill active={active === "relatorios"} onClick={()=>setActive("relatorios")}>Relatórios</Pill>
                  </div>
                </nav>
              </aside>

              {/* Main */}
              <main className="space-y-6">
                {active === "dashboard" && <DashboardView store={store} />}
                {active === "materiais" && (
                  <MateriaisView
                    data={store.materiais}
                    onCreate={createMaterial}
                    onUpdate={updateMaterial}
                    onDelete={deleteMaterial}
                  />
                )}
                {active === "associacoes" && (
                  <AssociacoesView
                    data={store.associacoes}
                    onCreate={createAssociacao}
                    onUpdate={updateAssociacao}
                    onDelete={deleteAssociacao}
                  />
                )}
                {active === "recebimentos" && (
                  <RecebimentosView
                    store={store}
                    setActive={setActive}
                    onCreate={createRecebimento}
                    onDelete={deleteRecebimento}
                    onCancel={cancelEntrada}
                  />
                )}
                {active === "vendas" && (
                  <VendasView
                    store={store}
                    setActive={setActive}
                    onCreate={createVenda}
                    onCancel={cancelVenda}
                  />
                )}
                {active === "relatorios" && (
                  <RelatoriosView
                    store={store}
                    onRemoveRange={removeRange}
                  />
                )}
              </main>
            </div>

            {/* Footer */}
            <footer className="py-8 text-center text-xs text-neutral-500">
              Modo Teste
            </footer>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
